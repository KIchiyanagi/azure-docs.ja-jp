---
title: "Site Recovery を使用して Azure にレプリケートされる Hyper-V VM のフェールオーバーとフェールバック | Microsoft Docs"
description: "Azure Site Recovery を使用して Hyper-V VM を Azure にフェールオーバーする方法と、オンプレミスにフェールバックする方法について説明します"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 72065d01-ed0f-430e-b117-a5885cecd1db
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/15/2017
ms.author: raynew
ms.openlocfilehash: e1cc21661450a983c25b24fe2a6228e26ceecec6
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/11/2017
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-azure"></a>Azure にレプリケートされる Hyper-V VM のフェールオーバーとフェールバック

[Azure Site Recovery](site-recovery-overview.md) サービスは、オンプレミスのコンピュータと Azure 仮想マシン (VM) のレプリケーション、フェールオーバー、およびフェールバックの管理と調整を行います。

このチュートリアルでは、Hyper-V VM と Azure にフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったときにオンプレミス サイトにフェールバックします。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * Hyper-V VM をオンプレミスから Azure にフェールオーバーする
> * Azure からオンプレミスにフェールバックし、Azure へのレプリケーションを再び開始する

## <a name="overview"></a>概要
フェールオーバーとフェールバックには 2 つの段階があります。

1. **Azure にフェールオーバーする**: オンプレミス サイトのコンピューターを Azure にフェールオーバーします。
2. **Azure からオンプレミスにフェールバックする**: Azure からオンプレミスへの計画されたフェールオーバーを実行します。 計画されたフェールオーバーの後、レプリケーションの反転を有効にして、オンプレミスから Azure へのレプリケーションを再び開始します。 


## <a name="fail-over-to-azure"></a>Azure にフェールオーバーする

### <a name="failover-prerequisites"></a>フェールオーバーの前提条件

フェールオーバーを完了するには:

- すべてが予想どおりに動作することを確認するための[ディザスター リカバリー訓練](tutorial-dr-drill-azure.md)を完了している必要があります。
- 必要に応じて、フェールオーバーを実行する前に、Azure VM への接続を準備します。
- フェールオーバーを実行する前に、VM のプロパティを確認します。

#### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>フェールオーバー後に Azure VM に接続するための準備をする

フェールオーバー後に RDP を使用して Azure VM に接続する場合は、次のことを行う必要があります。

##### <a name="azure-vms-running-windows"></a>Windows を実行中の Azure VM

1. インターネット経由で Azure VM にアクセスするには、フェールオーバーの前に、オンプレミスの VM で RDP を有効にします。 TCP と UDP の規則が **[パブリック]** プロファイルに追加されていることを確認し、**[Windows ファイアウォール]** > **[許可されたアプリ]** で、すべてのプロファイルで RDP が許可されていることを確認します。
2. サイト間 VPN 経由でアクセスするには、オンプレミスのコンピューターで RDP を有効にします。 RDP は、**[Windows ファイアウォール]** -> **[許可されたアプリおよび機能]** から、**ドメインとプライベート** ネットワークでの使用を許可する必要があります。 オペレーティング システムの SAN ポリシーが **[OnlineAll]** に設定されていることを確認します。 [詳細情報](https://support.microsoft.com/kb/3031135) フェールオーバーをトリガーするときに、VM に保留中の Windows 更新プログラムがないようにします。 ある場合は、更新が完了するまで、仮想マシンにログインすることはできません。 
3. フェールオーバー後の Microsoft Azure VM で **[ブート診断]** をオンにして、VM のスクリーンショットを確認します。 接続できない場合は、VM が実行中であることを確認したうえで、[トラブルシューティングのヒント](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)を確認してください。


##### <a name="azure-vms-running-linux"></a>Linux を実行中の VM

1. フェールオーバーする前に、オンプレミスのコンピューターで、システム起動時に Secure Shell サービスが自動的に開始するように設定されていることを確認します。 ファイアウォール規則で SSH 接続が許可されていることを確認します。
2. フェールオーバー後の Azure VM で、フェールオーバーされた VM とその接続先の Azure サブネットのネットワーク セキュリティ グループの規則について、SSH ポートへの受信接続を許可します。  VM の[パブリック IP アドレスを追加](site-recovery-monitoring-and-troubleshooting.md#adding-a-public-ip-on-a-resource-manager-virtual-machine)します。 **[ブート診断]** をオンにすると、VM のスクリーンショットを確認できます。


#### <a name="verify-vm-properties"></a>VM のプロパティを確認する

VM のプロパティで、VM が [Azure の要件](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)に準拠していることを確認します。

1. **[保護されているアイテム]** で、**[レプリケートされたアイテム]** をクリックし、VM をクリックします。
2. **[レプリケートされたアイテム]** ウィンドウには、VM 情報、正常性状態、および最新の使用可能な復旧ポイントの概要が表示されます。 **[プロパティ]** をクリックすると、詳細が表示されます。
3. **[コンピューティングとネットワーク]** で、Azure 名、リソース グループ、ターゲット サイズ、[可用性セット](../virtual-machines/windows/tutorial-availability-sets.md)、および[管理ディスクの設定](#managed-disk-considerations)を変更できます。
4. ネットワーク設定 (フェールオーバー後に Azure VM が配置されるネットワークやサブネット、割り当てられる IP アドレスなど) を表示および変更できます。
5. **[ディスク]** で、VM のオペレーティング システム ディスクとデータ ディスクに関する情報を確認できます。


### <a name="run-a-failover-from-on-premises-to-azure"></a>オンプレミスから Azure へのフェールオーバーを実行する

Hyper-V VM の通常のフェールオーバーまたは計画されたフェールオーバーを実行できます。

- 通常のフェールオーバーは、予期しない停止時に使用します。 このフェールオーバーを実行すると、Site Recovery が Azure VM を作成して起動します。 特定の復旧ポイントに対してフェールオーバーを実行します。 使用する復旧ポイントによってはデータ損失が発生する可能性があります。
- 計画されたフェールオーバーは、メンテナンスや想定された停止時に使用できます。 このオプションではデータ損失は発生しません。 計画されたフェールオーバーがトリガーされると、ソース VM がシャット ダウンされます。 同期されていないデータが同期され、フェールオーバーがトリガーされます。

この手順では、通常のフェールオーバーを実行する方法について説明します。


1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で、フェールオーバーする**[復旧ポイント]** を選択します。 次のいずれかのオプションを使うことができます。
    - **[最新]** (既定値): 最初に、Site Recovery に送信されるすべてのデータを処理します。 フェールオーバー後に作成された Azure VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
    - **[最後に処理があった時点]**: Site Recovery によって処理された最新の復旧ポイントに VM をフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
    - **[最新のアプリ整合性]**: Site Recovery によって処理されたアプリ整合性の最新の復旧ポイントに VM をフェールオーバーします。 
    - **カスタム**: 復旧ポイントを指定します。
3. System Center VMM クラウドの Hyper-V VM を Azure にフェールオーバーするときに、クラウドのデータ暗号化が有効になっている場合は、**[暗号化キー]** で、VMM サーバーでのプロバイダーのセットアップ中にデータ暗号化を有効にしたときに発行された証明書を選択します。
4. Site Recovery でフェールオーバーを開始する前にそのソース仮想マシンをシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 Site Recovery は、フェールオーバーをトリガーする前に、まだ Azure に送信されていないオンプレミス データの同期も試行します。 シャットダウンが失敗した場合でも、フェールオーバーは続行されることに注意してください。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
5. Azure VM に接続する準備が完了したら、フェールオーバー後に接続して確認します。
6. 確認が完了したら、フェールオーバーを**コミット**します。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> **進行中のフェールオーバーをキャンセルしないでください**。フェールオーバーが開始される前に VM のレプリケーションが停止します。 進行中のフェールオーバーをキャンセルすると、フェールオーバーは停止しますが、VM が再びレプリケートされることはありません。  


## <a name="fail-back-from-azure-to-on-premises"></a>Azure からオンプレミスにフェールバックする

### <a name="prerequisites-for-failback"></a>フェールバックの前提条件

フェールバックを完了するには、プライマリ サイトの VMM サーバー/Hyper-V サーバーが Site Recovery に接続されている必要があります。


### <a name="run-a-failback-and-reprotect-on-premises-vms"></a>フェールバックを実行してオンプレミスの VM を再び保護する

Azure からオンプレミス サイトにフェールオーバーし、オンプレミス サイトから Azure への VM のレプリケーションを開始します。

1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[計画されたフェールオーバー]** をクリックします。
2. **[計画されたフェールオーバーの確認]** で、フェールオーバーの方向 (Azure から) を確認し、ソースとターゲットの場所を選択します。 
3. **[データの同期]** で、同期方法を指定します。
    - **[フェールオーバーの前にデータを同期する (差分変更のみを同期する)]** - VM をシャットダウンせずに同期するため、VM のダウンタイムが最小限に抑えられます。 これは次のように動作します。
        1. Azure VM のスナップショットを取得し、オンプレミスの Hyper-V ホストにコピーします。 VM は Azure で実行を続けます。
        2. 新しい変更が行われないように、Azure VM をシャットダウンします。 差分変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの VM が起動されます。
    - **[フェールオーバー中にのみデータを同期する (すべてダウンロードする)]**- Azure の実行期間が長い場合にこのオプションを使用します。 ディスクの複数の変更を想定してチェックサムの計算に時間を費やさないようにしているため、このオプションを選択すると高速になります。 このオプションでは、ディスク ダウンロードを実行します。 これは、オンプレミスの VM が削除されている場合にも便利です。
4. System Center VMM クラウドの Hyper-V VM を Azure にフェールオーバーするときに、クラウドのデータ暗号化が有効になっている場合は、**[暗号化キー]** で、VMM サーバーでのプロバイダーのセットアップ中にデータ暗号化を有効にしたときに発行された証明書を選択します。
5. フェールオーバーを開始します。 フェールオーバーの進行状況は、 **[ジョブ]** タブで確認できます。
6. フェールオーバー前のデータ同期を選択した場合、初回のデータ同期が完了し、Azure VM をシャットダウンする準備ができた時点で、**[ジョブ]** > 計画されたフェールオーバーのジョブ名 > **[フェールオーバーの完了]** をクリックします。 これにより Azure VM がシャットダウンされ、最新の変更がオンプレミスに転送され、オンプレミスの VM が起動します。
7. オンプレミスの VM にログオンして、それが期待どおりに使用できることを確認します。
8. オンプレミスの VM は、この時点ではコミット保留中の状態です。 **[コミット]** をクリックして、フェールオーバーをコミットします。 これにより、Azure VM とそのディスクが削除され、オンプレミスの VM でレプリケーションの反転が準備されます。
9. オンプレミスの VM の Azure へのレプリケーションを開始するには、**[レプリケーションの反転]** を有効にします。


> [!NOTE]
> レプリケーションの反転では、Azure VM が停止してから発生した変更のみがレプリケートされ、差分変更のみが送信されます。

