---
title: "エネルギー需要の時系列予測 | Microsoft Docs"
description: "Azure Machine Learning workbench で機械学習をエネルギー需要の時系列予測に適用する方法。"
services: machine-learning
documentationcenter: 
author: anta
manager: ireiter
editor: anta
ms.assetid: 
ms.service: machine-learning
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/15/2017
ms.author: anta
ms.openlocfilehash: bd0ddfcffdb6f946f9a3786f3d0add1740be861b
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/11/2017
---
# <a name="energy-demand-time-series-forecasting"></a>エネルギー需要の時系列予測


時系列予測は、時間順に並べられた、連続した観測の将来の値を予測するタスクです。 これは一般的な問題で、多くの業界に応用できます。 たとえば、小売会社は、需要を満たすために、サプライ チェーンを効果的に編成するために、将来の製品売上を予測する必要があります。 同様に、小包を配送する会社では、従業員の需要と配達ルートを事前に計画できるように、サービスの需要を予測する必要があります。 多くの場合、予測が不正確であると、重大な財務上のリスクが発生します。 そのため、多くの場合、予測は、ビジネス上重要な活動です。

このサンプルでは、機械学習技法を適用することにより、どのように時系列予測を実行できるかを示します。 次のようなモデリング プロセスを手順を追って説明します。
- データのクリーンアップとフォーマットの準備
- 機械学習モデルのための機能を時系列の生データから作成
- さまざまな機械学習モデルをトレーニング
- 保持されているテスト データセットのパフォーマンスを比較することによって、モデルを評価
- 最適なモデルを運用して、Web サービスを通じて提供してオンデマンドの予測を生成する

Azure Machine Learning Workbench は、各手順で、モデリング プロセスを補完します。 
- サンプルは、Workbench から直接使用できる Jupyter ノートブック環境で Python コードを簡単に開発できることを示します。 マークダウン注釈とグラフを使用することで、より明確にモデルの開発プロセスを他のユーザーに説明できます。 これらのノートブックは、Workbench から直接、表示、編集、および、実行できます。
- トレーニング済みモデルは、永続化し、BLOB ストレージにアップロードできます。 これにより、データ サイエンティストは、トレーニング済みモデルのオブジェクトを追跡、保持し、必要なときに取得できます。
- Python スクリプトの実行中に指標をログに記録でき、データ サイエンティストは、モデルのパフォーマンス スコアを保存できます。
- ワークベンチは、データ サイエンティストがモデルのパフォーマンス指標を簡単に比較できるよう、ログに記録された指標のカスタマイズ可能な表を生成します。 パフォーマンスが最も高いモデルを簡単に判断できるよう、グラフが自動的に表示されます。
- 最後に、このサンプルは、トレーニング済みモデルをリアルタイム Web サービスに展開し、運用化する方法を示します。

## <a name="link-to-the-gallery-github-repository"></a>ギャラリーの GitHub リポジトリへのリンク
この実際のシナリオに対応するパブリック GitHub リポジトリには、コード サンプルなど、この例に必要なすべての素材が含まれています。

[https://github.com/Azure/MachineLearningSamples-EnergyDemandTimeSeriesForecasting](https://github.com/Azure/MachineLearningSamples-EnergyDemandTimeSeriesForecasting)


## <a name="use-case-overview"></a>ユース ケースの概要

このシナリオでは、エネルギー グリッドの将来の負荷を予測する目的で、エネルギー需要を予測します。 エネルギー セクターの企業にとって、グリッド上で消費される電力と供給されるエネルギーの間でバランスを取ることは、重要な営業活動になります。 グリッドに供給される電力が多すぎると、エネルギーが無駄になったり、技術的な故障の原因になります。 ただし、供給電力が少なすぎると、停電や、顧客に電力が供給されない原因になります。 通常、電力会社は、グリッドに供給される電力を管理し、負荷のバランスを取るために、短期間的な決定を下します。 このため、精度の高い決定を下すために、短期間のエネルギー需要を正確に予測ことは、電力会社にとって非常に重要です。

このシナリオでは、機械学習のエネルギー需要予測ソリューションの構築について説明します。 ソリューションは、ニューヨーク州の電力グリッドを運営する、[ニューヨークの独立系電力会社 (NYISO)](http://www3.dps.ny.gov/W/PSCWeb.nsf/All/298372E2CE4764E885257687006F39DF?OpenDocument) からのパブリック データセットについてトレーニングします。 データセットには、ニューヨーク市の 5 年間の時間ごとの電力需要データが含まれています。 同じ期間の 1 時間ごとのニューヨークの気象状況を含む追加のデータセットを [darksky.net](https://darksky.net) から取得しました。

## <a name="prerequisites"></a>前提条件

- [Azure アカウント](https://azure.microsoft.com/free/) (無料試用版もご利用いただけます)。
- [Azure Machine Learning Workbench](./overview-what-is-azure-ml.md) のインストール済みコピー。[クイックスタート インストール ガイド](./quickstart-installation.md)に従ってプログラムをインストールし、ワークスペースを作成します。
- このサンプルは、[Docker エンジン](https://www.docker.com/)をローカルにインストールした Windows 10 で Azure Machine Learning Workbench を実行していることを前提とします。 macOS を使用している場合も、手順の多くは変わりません。
- ローカル デプロイメント環境セットアップでインストールされた Azure Machine Learning Operationalization および、この[ガイド](https://github.com/Azure/Machine-Learning-Operationalization/blob/master/documentation/getting-started.md)の説明に従って作成されたモデル管理アカウント。
- このサンプルでは、Pandas をバージョン 0.20.3 以上にアップデートし、matplotlib をインストールする必要があります。 Workbench の *[ファイル]* メニューから *[コマンド プロンプトを開く]* をクリックし、次のコマンドを実行してこれらの依存関係をインストールします。

    ```
    conda install "pandas>=0.20.3"

    conda install matplotlib
    ```
    
## <a name="create-a-new-workbench-project"></a>新しい Workbench プロジェクトの作成

この例をテンプレートとして使用して新しいプロジェクトを作成します。
1.  Azure Machine Learning Workbench を開きます
2.  **[プロジェクト]** ページで **+** 記号をクリックし、**[新しいプロジェクト]** を選択します
3.  **[新しいプロジェクトの作成]** ウィンドウで、新しいプロジェクトの情報を入力します。
4.  **[プロジェクト テンプレートの検索]** 検索ボックスに、「Energy Demand Time Series Forecasting」と入力し、テンプレートを選択します
5.  **[作成]**


## <a name="data-description"></a>データの説明

`nyc_demand.csv` と `nyc_weather.csv` の2 つのデータセットがあります。

**nyc_demand.csv** には、2012 ～ 2017 年のニューヨーク市における 1 時間ごとのエネルギー需要値が含まれています。 データは、次のような単純な構造です。

| timeStamp | demand |
| --- | --- |
| 2012-01-01 00:00:00 | 4937.5 |
| 2012-01-01 01:00:00 | 4752.1 |
| 2012-01-01 02:00:00 | 4542.6 |
| 2012-01-01 03:00:00 | 4357.7 |

需要値は、メガワット時間 (MWh) 単位です。 以下は、2017 年 7 月の 7 日間にわたるエネルギー需要のグラフです。

![エネルギー需要](./media/scenario-time-series-forecasting/energy_demand.png  "エネルギー需要")

**nyc_weather.csv** には、2012 ～ 2017 年のニューヨーク市における 1 時間ごとの天候値が含まれています。

| timeStamp | precip | temp
| --- | --- | --- |
| 2012-01-01 00:00:00 | 0.0 | 46.13 |
| 2012-01-01 01:00:00 | 0.01 | 45.89 |
| 2012-01-01 02:00:00 | 0.05 | 45.04 |
| 2012-01-01 03:00:00 | 0.02 | 45.03 |

*precip* は、降水量の割合尺度です。 *temp* (温度) 値は、すべての値が [0, 100] の間隔に分類されるよう再スケーリングされています。

## <a name="scenario-structure"></a>シナリオの構造

このプロジェクトを Azure Machine Learning Workbench ではじめて開いた場合は、左側のウィンドウの *[ファイル]* ウィンドウに移動します。 このサンプルでは、次のコード ファイルが用意されています。
- `1-data-preparation.ipynb` - この Jupyter ノートブックは、データをダウンロードして処理し、モデリングに準備します。 これは、実行する最初のノートブックです。
- `2-linear-regression.ipynb` - このノートブックは、トレーニング データの線形回帰モデルをトレーニングします。
- `3-ridge.ipynb` - ねじ山回帰モデルをトレーニングします。
- `4-ridge-poly2.ipynb` - 二次多項式機能にねじ山回帰モデルをトレーニングします。
- `5-mlp.ipynb` - マルチレイヤー パーセプトロン ニューラル ネットワークをトレーニングします。
- `6-dtree.ipynb` - デシジョン ツリー モデルをトレーニングします。
- `7-gbm.ipynb` - グラデーションのブースト マシン モデルをトレーニングします。
- `8-evaluate-model.py` - このスクリプトはトレーニング済みモデルを読み込み、保持されているテスト データセットを使って予測するために使用します。 異なるモデルのパフォーマンスを比較できるように、モデル評価指標を生成します。
- `9-forecast-output-exploration.ipynb` - このノートブックでは、機械学習モデルによって生成された予測の視覚化が生成されます。
- `10-deploy-model.ipynb` - このノートブックは、トレーニング済み予測モデルを、リアルタイムの Web サービスで運用化する方法を示しています。
- `evaluate-all-models.py` - このスクリプトは、すべてのトレーニング済みモデルを評価します。 このスクリプトを使用すれば、トレーニング済みモデルごとに個別に `8-evaluate-model.py` を実行しなくても済みます。

### <a name="1-data-preparation-and-cleaning"></a>1.データの準備とクリーンアップ

サンプルの実行を開始するには、まず `1-data-preparation.ipynb` をクリックして、ノートブックをプレビュー モードで開きます。 ***[ノートブック サーバーの起動]*** をクリックして Jupyter ノートブック サーバーおよびコンピューター上の Python カーネルを起動します。 Workbench 内からノートブックを実行するか、またはブラウザーを使用して [http://localhost:8888](http://localhost:8888) に移動できます。 カーネルを *PROJECT_NAME local* に変更する必要がある点に注意してください。 これは、ノートブックの *[カーネルの変更]* メニューの下にある *[カーネル]* から操作できます。 ***shift + enter*** キーを押して、ノートブックのセルごとにコードを個別に実行するか、*[セル]* メニューの [*すべて実行*] をクリックして、ノートブック全体を実行できます。

ノートブックはまず、Azure でホストされている BLOB ストレージ コンテナーからデータをダウンロードします。 次に、コンピューター上の `AZUREML_NATIVE_SHARE_DIRECTORY` にデータが格納されます。 この場所は、すべてのノートブックまたは Workbench から実行するスクリプトからアクセスできますので、データやトレーニング済みモデルを格納する場所として適しています。

データをダウンロードすると、ノートブックは、時系列内のギャップを埋めたり、欠けている値を補間し、データをクリーンアップします。 この方法で時系列データをクリーンアップすると、モデルのトレーニングに使用できるデータの量が最大化します。

モデルのいくつかの機能は、クリーンアップされた生データから作成されます。 これらの機能は、2 つのグループに分類できます。

- **時間駆動の機能**は、*month*、*dayofweek*、*hour* などの *timestamp* 変数から派生しています。
- **タイム ラグ機能**は、実際の需要および温度値の時間をずらした値です。 これらの機能の目的は、モデル内の連続する期間での条件的な依存関係を把握することす。

結果として得られる機能データセットを使用して予測モデルを開発できます。

### <a name="2-model-development"></a>2.モデルの開発

最初のモデリング アプローチは、より単純な線形回帰モデルです。 `2-linear-regression.ipynb` のノートブックは、将来のエネルギー需要の線形回帰の予測モデルをトレーニングする方法を示しています。 特に、モデルは、現在の期間 (*t*)より 1 時間前 (*t は + 1*) のエネルギー需要を予測するようトレーニングされます。 ただし、この 'ワンステップ' モデルは、テスト時に再帰的に適用して、将来の期間 *t+n* の予測を生成することができます。

モデルをトレーニングするために、3 つの手順を使用して予測パイプラインが作成されます。

- **データ変換**: 入力データに必要な形式は、機械学習アルゴリズムによって異なる場合があります。 この場合、線形回帰モデルでは、 1 つのホット エンコードされたカテゴリ変数が必要です。
- **クロス検証ルーチン**: 多くの場合、機械学習モデルには、実験を通してチューニングする必要のある 1 つまたは複数のハイパーパラ メーターが存在します。 パラメーター値の最適なセットは、クロス検証を使用して特定できます。 モデルは、データセットのさまざまなフォールドで、繰り返しトレーニングおよび評価されます。 最適なパラメーターは、複数のクロス検証フォールドの平均で最適なモデル パフォーマンスが達成されるパラメーターです。 このプロセスについては、`2-linear-regression.ipynb` で詳しく解説されています。
- **最終的なモデルをトレーニング**: モデルは、最適なハイパーパラ メーターのセットを使用して、データセット全体でトレーニングされます。

ノートブック 2 ～ 7 に 6 つの異なるモデルが付属しています。 各ノートブックは、それぞれ別のモデルをトレーニングし、`AZUREML_NATIVE_SHARE_DIRECTORY` に格納します。 このシナリオ用に開発されたすべてのモデルをトレーニングすると、次のセクションで説明ているように、評価したり比較したりできます。

### <a name="3-model-evaluation-and-comparison"></a>3.モデルの評価と比較

トレーニング済みモデルを使用して、将来の期間を予測できます。 保持されているテスト データセットでこれらのモデルを評価することをお勧めします。 隠された同じデータセットで異なるモデルを評価することで、パフォーマンスを公平に比較し、最適なモデルを特定できます。 このシナリオでは、トレーニング済みモデルを再帰的に適用して、将来の複数の時間ステップを予測します。 具体的には、最大 6 時間、現在の時間 *t* から *t+6* 時間先を予測します。 これらの予測は、各期間観察された実際の要求に対して評価されます。

モデルを評価するには、Workbenchの *[ファイル]* ウィンドウからスクリプト `8-evaluate-model.py`を開きます。 *[実行構成]* に **[ローカル]** が設定されていることを確認し、*[引数]* フィールドにモデルの名前を入力します。 モデル名は、モデルがトレーニングを受けたノートブックの先頭に設定された *model_name* 変数と正確に一致する必要があります。 たとえば、トレーニング済みの線形回帰モデルを評価するには、「linear_regression」と入力します。 または、すべてのモデルがトレーニングされたら、すべてのモデルを 1 つのコマンド `evaluate-all-models.py` を実行して評価できます。 このスクリプトを実行するには、Workbench からコマンド プロンプトを開き、次のコマンドを実行します。

```
python evaluate-all-models.py
```
`8-evaluate-model.py` スクリプトは、次の操作を実行します。

- トレーニング済みモデルのパイプラインをディスクから読み込みます
- テスト データセットを使って予測します
- モデルのパフォーマンス指標を計算し、ログに記録します
- 後で検査および分析するために、テスト データセット予測を `AZUREML_NATIVE_SHARE_DIRECTORY` に保存します
- トレーニング済みモデル パイプラインを、*outputs* フォルダーに保存します。

> [!Note]
> モデルを *outputs* フォルダーに保存すると、実験アカウントに関連付けられている Azure Blob Storage アカウントに、モデル オブジェクトが自動的にコピーされます。 このため、コンピューターを変更したり、計算コンテキストを変更した場合でも、BLOB から保存済みのモデル オブジェクトをいつでも取得できます。

*[実行履歴]* ウィンドウに移動し、`8-evaluate-model.py` をクリックします。 モデルの複数のパフォーマンス指標がグラフに表示されます。

- **ME**: 予測の平均誤差。 これは、予測の平均バイアスとして解釈できます。
- **MPE**:[平均誤差率](https://en.wikipedia.org/wiki/Mean_percentage_error) (ME は、実際の需要の比率として表されます)
- **MSE**: [二乗平均誤差](https://en.wikipedia.org/wiki/Mean_squared_error)
- **RMSE**: 平均平方根誤差 (MSE の平方根)
- **MAPE E**: [平均絶対誤差率](https://en.wikipedia.org/wiki/Mean_absolute_percentage_error)
- **sMAPE**: [対称平均絶対誤差率](https://en.wikipedia.org/wiki/Symmetric_mean_absolute_percentage_error)
- **MAPE_base**: 予測が最後の既知の需要値と等しい、ベースライン予測の MAPE。
- **MdRAE**:相対絶対誤差の中央値。 ベースライン予測誤差に対する、予測誤差の中央値比。 値が 1 未満の場合、予測はベースラインより正確です。

上記のすべての指標は、*t+1* 予測を参照します。 上記の指標に加え、*_horizon* のサフィックスが付いた、対応する指標セットも表示されます。 これは、*t+1* ～ *t+6* の期間にわたる、予測期間全体で平均された指標です。

指標がグラフ エリアに表示されない場合は、右上隅の歯車アイコンをクリックします。 関心のあるモデル パフォーマンス指標がオンになっていることを確認します。 指標は、グラフの下の表にも表示されます。 この表も、歯車アイコンをクリックしてカスタマイズできます。 パフォーマンス指標ごとに表を並べ替えると、最適がモデルが特定できます。 *t+1* ～ *t+6* の期間で予測パフォーマンスがどのように変化するかに関心がある場合は、表内のモデルのエントリをクリックします。 MAPE を表示するグラフでは、予測期間にわたる MPE と MdRAE 指標が *[視覚化]* の下に表示されます。

予測モデルを評価する際に、出力予測を視覚化すると便利な場合があります。 これにより、データ サイエンティストは、生成された予測が現実的かどうかを判断できます。 これは、たとえば、特定の期間予測の精度が低い場合に、予測の問題を特定するためにも役立ちます。 `9-forecast-output-exploration.ipynb` ノートブックは、テスト データセットに対して生成された予測を視覚化します。

### <a name="4-deployment"></a>4.デプロイ

リアルタイム Web サービスとして展開することで、最適なモデルを運用化できます。 この Web サービスを呼び出して、新しいデータが利用可能になったときにオンデマンドで予測を生成できます。 このシナリオでは、新しい予測は、その後の時間の電力需要を予測するために 1 時間ごとに生成される必要があります。 このタスクを実行するために、入力として特定の期間を取り、出力として予想された需要を返す、一連の機能を持った Web サービスをデプロイできます。

このサンプルでは、Web サービスは、Windows 10 コンピューターにデプロイされます。 この[ファースト ステップ ガイド](https://github.com/Azure/Machine-Learning-Operationalization/blob/master/documentation/getting-started.md)に書かれている、Operationalization CLI.のローカル デプロイメントのための前提条件となる手順を実行してください。 ローカル環境とモデルの管理アカウントを設定したら、`10-deploy-model.ipynb`ノートブックを実行して、Web サービスをデプロイします。

## <a name="conclusion"></a>まとめ

このサンプルは、エネルギー需要を予測する目的で、エンド ツー エンド時系列予測ソリューションを構築する方法を示しています。 このサンプルで説明した原則の多くは、他の予測シナリオや業界に拡張できます。

このシナリオでは、データ サイエンティストが、Jupyter ノートブック環境やメトリックのログ記録機能などの Azure Machine Learning Workbench の 便利な機能を使って、どのように実際のソリューションを開発できるかを示しました。 サンプルでは、Azure Machine Learning Operationalization CLI を使用してモデルをどのように運用化し、デプロイできるかについても説明しました。 Web サービス API をデプロイすると、開発者またはデータ エンジニアは、予測モデルをより幅広いデータ パイプラインに統合できます。
