---
title: "Azure Virtual Machines (クラシック) での AlwaysOn 可用性グループの構成 | Microsoft Docs"
description: "Azure Virtual Machines で AlwaysOn 可用性グループを作成します。 このチュートリアルでは、スクリプトではなく、主にユーザー インターフェイスとツールを使用します。"
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 8d48a3d2-79f8-4ab0-9327-2f30ee0b2ff1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
ms.openlocfilehash: b360fe9f28eeb9b10c82fce729165b1b572ac3c6
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/11/2017
---
# <a name="configure-always-on-availability-group-in-azure-virtual-machines-classic"></a>Azure Virtual Machines (クラシック) での AlwaysOn 可用性グループの構成
> [!div class="op_single_selector"]
> * [クラシック: UI](../classic/portal-sql-alwayson-availability-groups.md)
> * [クラシック: PowerShell](../classic/ps-sql-alwayson-availability-groups.md)
<br/>

開始する前に、Azure Resource Manager モデルでこのタスクを完了できるかを検討してください。 新たにデプロイする場合、Azure Resource Manager モデルを使用することをお勧めします。 [Azure Virtual Machines での SQL Server Always On 可用性グループ](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md)に関するページをご覧ください。

> [!IMPORTANT] 
> 最新のデプロイでは、リソース マネージャー モデルを使用することをお勧めします。 Azure には、リソースの作成と操作を行う、[Resource Manager とクラシック](../../../azure-resource-manager/resource-manager-deployment-model.md)の 2 種類のデプロイメント モデルがあります。 この記事では、クラシック デプロイメント モデルの使用方法について説明します。 

Azure Resource Manager モデルでこの作業を行う場合は、[Azure 仮想マシン上の SQL Server Always On 可用性グループ](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md)に関する記事をご覧ください。

このエンド ツー エンドのチュートリアルでは、Azure Virtual Machines で実行されている SQL Server AlwaysOn を使用して可用性グループを実装する方法について説明します。

チュートリアルの最後には、次の要素で構成された SQL Server AlwaysOn ソリューションが Azure で完成します。

* 複数のサブネットから成り、フロントエンドとバックエンドのサブネットを含む仮想ネットワーク
* Active Directory (Azure AD) ドメインを持つドメイン コントローラー
* SQL Server を実行し、バックエンドのサブネットにデプロイされて Azure AD ドメインに参加している 2 つの仮想マシン
* 3 ノードのフェールオーバー クラスター (ノード マジョリティ クォーラム モデル)
* 可用性データベースの 2 つの同期コミット レプリカを含む可用性グループ

次の図は、このソリューションをグラフィカルに表したものです。

![Azure の可用性グループのテスト ラボ アーキテクチャ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC791912.png)

これは、考えられる 1 つの構成であることに注意してください。 たとえば、2 つのレプリカの可用性グループで、仮想マシンの数を最小限にできます。 この構成では、ドメイン コント ローラーを 2 ノード クラスターでクォーラム ファイル共有監視として使用することで、Azure でのコンピューティング時間を節約します。 この方法によって、図に示した構成から仮想マシンの数が 1 つ減少します。

このチュートリアルでは、次のことを前提としています。

* Azure アカウントを既に所有している。
* 仮想マシン ギャラリーで GUI を使用して、SQL Server を実行する従来の仮想マシンをプロビジョニングする方法を知っている。
* AlwaysOn 可用性グループについて十分に理解している。 詳細については、「 [AlwaysOn 可用性グループ (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx)」をご覧ください。

> [!NOTE]
> SharePoint での AlwaysOn 可用性グループの使用に関心がある場合は、「[SQL Server 2012 の AlwaysOn 可用性グループを SharePoint 2013 用に構成する](https://technet.microsoft.com/library/jj715261.aspx)」をご覧ください。
> 
> 

## <a name="create-the-virtual-network-and-domain-controller-server"></a>仮想ネットワークとドメイン コントローラー サーバーの作成
最初に新しい Azure 試用版アカウントを作成します。 アカウントをセットアップしたら、Azure クラシック ポータルのホーム画面が表示されます。

1. 次のスクリーン ショットに示すように、ページの左下隅にある **[新規]** ボタンをクリックします。
   
    ![ポータルで 新規をクリックします](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665511.gif)
2. 次のスクリーンショットに示すように、**[ネットワーク サービス]** > **[仮想ネットワーク]** > **[カスタム作成]** の順にクリックします。
   
    ![[仮想ネットワークの作成]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665512.gif)
3. **[仮想ネットワークの作成]** ダイアログ ボックスの各ページで、次の表の設定を使用して新しい仮想ネットワークを作成します。 
   
   | ページ | 設定 |
   | --- | --- |
   | Virtual Network Details |**NAME = ContosoNET**<br/>**リージョン = 米国西部** |
   | DNS サーバーと VPN 接続 |なし |
   | Virtual Network アドレス空間 |次のスクリーンショットに設定を示します。 ![[仮想ネットワークの作成]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784620.png) |
4. ドメイン コントローラー (DC) として使用する仮想マシンを作成します。 次のスクリーンショットに示すように、**[新規]** > **[計算]** > **[仮想マシン]** > **[ギャラリーから]** をクリックします。
   
    ![仮想マシンの作成](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784621.png)
5. **[仮想マシンの作成]** ダイアログ ボックスの各ページで、次の表の設定を使用して新しい仮想マシンを構成します。 
   
   | ページ | 設定 |
   | --- | --- |
   | 仮想マシンのオペレーティング システムの選択 |Windows Server 2012 R2 Datacenter |
   | 仮想マシンの構成 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoDC<br/>**[階層]** = Standard<br/>**[サイズ]** = A2 (2 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |
   | 仮想マシンの構成 |**[クラウド サービス]** = 新しいクラウド サービスの作成<br/>**[クラウド サービス DNS 名]** = 一意のクラウド サービス名<br/>**[DNS 名]** = 一意の名前 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = (なし) |
   | 仮想マシンのオプション |既定値を使用 |

新しい仮想マシンを構成したら、仮想マシンがプロビジョニングされるまで待機します。 このプロセスは完了するまで時間がかかります。 Azure クラシック ポータルで **[仮想マシン]** タブをクリックすると、ContosoDC の状態が **[開始中 (プロビジョニング中)]** から **[停止済み]**、**[開始中]**、**[実行中 (プロビジョニング中)]**、最後に **[実行中]** へ変化していくことがわかります。

これで、DC サーバーは正常にプロビジョニングされました。 次に、この DC サーバー上の Active Directory ドメインを構成します。

## <a name="configure-the-domain-controller"></a>ドメイン コントローラーの構成
次の手順では、corp.contoso.com のドメイン コントローラーとして ContosoDC コンピューターを構成します。

1. ポータルで、 **ContosoDC** コンピューターを選択します。 **[ダッシュボード]** タブで、**[接続]** をクリックし、リモート デスクトップ アクセス用のリモート デスクトップ (RDP) ファイルを開きます。
   
    ![仮想マシンに接続](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784622.png)
2. 構成した管理者アカウント (**\AzureAdmin**) とパスワード (**Contoso!000**) でサインインします。
3. 既定では、 **[サーバー マネージャー]** ダッシュボードが表示されます。
4. ダッシュボードの **[役割と機能の追加]** リンクをクリックします。
   
    ![サーバー エクスプローラー、ロールの追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784623.png)
5. **[サーバーの役割]** セクションが表示されるまで **[次へ]** をクリックします。
6. **[Active Directory Domain Services]** と **[DNS サーバー]** という役割を選択します。 メッセージが表示されたら、これらの役割が必要とする機能をさらに追加します。
   
   > [!NOTE]
   > 静的 IP アドレスがないことを示す検証の警告が表示されます。 構成をテストしている場合は、**[続行]** をクリックします。 運用シナリオの場合は、[PowerShell を使用して、ドメイン コントローラー コンピューターの静的 IP アドレスを設定してください](../../../virtual-network/virtual-networks-reserved-private-ip.md)。
   > 
   > 
   
    ![ロールの追加の図表](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784624.png)
7. **[確認]** セクションが表示されるまで **[次へ]** をクリックします。 **[必要に応じてターゲット サーバーを自動的に再起動する]** チェック ボックスをオンにします。
8. **[インストール]**をクリックします。
9. 機能がインストールされたら、**[サーバー マネージャー]** ダッシュボードに戻ります。
10. 左側のウィンドウで新しい **[AD DS]** オプションを選択します。
11. 黄色の警告バーにある **[その他]** リンクをクリックします。
    
     ![DNS サーバー仮想マシンでの [AD DS] ダイアログ ボックス](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784625.png)
12. **[すべてのサーバー タスクの詳細]** ダイアログ ボックスの **[操作]** 列で、**[このサーバーをドメイン コントローラーに昇格する]** をクリックします。
13. **Active Directory Domain Services の構成ウィザード**で、次の値を使用します。
    
    | ページ | 設定 |
    | --- | --- |
    | デプロイ構成 |**[新しいフォレストの追加]** = 選択<br/>**[ルート ドメイン名]** = corp.contoso.com |
    | ドメイン コントローラー オプション |**パスワード** = Contoso!000<br/>**[パスワードの確認]** = Contoso!000 |
14. **[次へ]** をクリックして、ウィザード内の他のページを進めます。 **[前提条件のチェック]** ページで、"**すべての前提条件のチェックに合格しました**" というメッセージが表示されることを確認します。 関連する警告メッセージをすべて確認する必要がありますが、インストールは続行できます。
15. **[インストール]**をクリックします。 **ContosoDC** 仮想マシンは自動的に再起動します。

## <a name="configure-domain-accounts"></a>ドメイン アカウントの構成
次の手順では、後で使用する Active Directory アカウントを構成します。

1. **ContosoDC** コンピューターに再度サイン インします。
2. **[サーバー マネージャー]** で、**[ツール]** > **[Active Directory 管理センター]** をクリックします。
   
    ![[Active Directory 管理センター]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784626.png)
3. **[Active Directory 管理センター]** で、左側のウィンドウの **[corp (ローカル)]** を選択します。
4. 右側の **[タスク]** ウィンドウで、**[新規]** > **[ユーザー]** をクリックします。 次の設定を使用します。
   
   | 設定 | 値 |
   | --- | --- |
   | **名** |[インストール] |
   | **ユーザー SAM アカウント名** |[インストール] |
   | **パスワード** |Contoso!000 |
   | **パスワードの確認** |Contoso!000 |
   | **その他のパスワード オプション** |オン |
   | **パスワードを無期限にする** |オン |
5. **[OK]** をクリックして **Install** ユーザーを作成します。 このアカウントは、フェールオーバー クラスターと可用性グループの構成に使用されます。
6. 同じ手順を使用して、さらに 2 つのユーザー (**CORP\SQLSvc1** と **CORP\SQLSvc2**) を作成します。 これらのアカウントは、SQL Server インスタンスに使用されます。 次に、必要なアクセス許可を **CORP\Install** に付与し、Windows Server フェールオーバー クラスタリングを構成する必要があります。
7. **[Active Directory 管理センター]** で、左側のウィンドウの **[corp (ローカル)]** をクリックします。 **[タスク]** ウィンドウで **[プロパティ]** をクリックします。
   
    ![CORP ユーザー プロパティ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784627.png)
8. **[拡張機能]** を選択し、**[セキュリティ]** タブの **[詳細設定]** をクリックします。
9. **[corp のセキュリティの詳細設定]** ダイアログ ボックスで、**[追加]** をクリックします。
10. **[プリンシパルの選択]** をクリックし、「**CORP\Install**」を検索して、**[OK]** をクリックします。
11. **[すべてのプロパティの読み取り]** アクセス許可と **[コンピューター オブジェクト作成]** アクセス許可を選択します。
    
     ![CORP ユーザー権限](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784628.png)
12. **[OK]** をクリックし、もう一度 **[OK]** をクリックします。 corp のプロパティ ウィンドウを閉じます。

これで Active Directory とユーザー オブジェクトを構成したので、3 つの SQL Server 仮想マシンを作成してこのドメインに参加させます。

## <a name="create-the-sql-server-virtual-machines"></a>SQL Server 仮想マシンの作成
3 つの仮想マシンを作成します。 1 つはクラスター ノード用で、2 つは SQL Server 用です。 各仮想マシンを作成するには、Azure クラシック ポータルに戻り、**[新規]** > **[計算]** > **[仮想マシン]** > **[ギャラリーから]** の順にクリックします。 その後、次の表のテンプレートを使用すると、仮想マシンの作成に役立ちます。

| ページ | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| 仮想マシンのオペレーティング システムの選択 |**Windows Server 2012 R2 Datacenter** |**SQL Server 2014 RTM Enterprise** |**SQL Server 2014 RTM Enterprise** |
| 仮想マシンの構成 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoWSFCNode<br/>**[階層]** = Standard<br/>**[サイズ]** = A2 (2 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoSQL1<br/>**[階層]** = Standard<br/>**[サイズ]** = A3 (4 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoSQL2<br/>**[階層]** = Standard<br/>**[サイズ]** = A3 (4 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |
| 仮想マシンの構成 |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = 可用性セットを作成<br/>**[可用性セット名]** = SQLHADR |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = SQLHADR (マシンが作成された後に可用性セットを構成することもできます。 3 つの仮想マシンはすべて SQLHADR 可用性セットに割り当てる必要があります。) |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = SQLHADR (マシンが作成された後に可用性セットを構成することもできます。 3 つの仮想マシンはすべて SQLHADR 可用性セットに割り当てる必要があります。) |
| 仮想マシンのオプション |既定値を使用 |既定値を使用 |既定値を使用 |

<br/>

> [!NOTE]
> 前の構成は、Standard レベルの仮想マシンを想定しています。Basic レベルのマシンでは、エンドポイントの負荷分散がサポートされません。 可用性グループ リスナーを作成するために、後でエンドポイントの負荷分散が必要になります。 また、ここで示されるマシンのサイズは、Azure Virtual Machines での可用性グループのテストに対応しています。 運用時のワークロードに対して最適なパフォーマンスを得る方法については、「[Azure Virtual Machines における SQL Server のパフォーマンスのベスト プラクティス](../sql/virtual-machines-windows-sql-performance.md)」の SQL Server マシンのサイズと構成に関する推奨事項を参照してください。
> 
> 

3 つの仮想マシンが完全にプロビジョニングされたら、それらの仮想マシンを **corp.contoso.com** ドメインに参加させて、それらに対する管理者権限を CORP\Install に付与する必要があります。 この操作を行うには、3 つの仮想マシンそれぞれで、次の手順を実行します。

1. まず、優先 DNS サーバー アドレスを変更します。 一覧で仮想マシンを選択して **[接続]** クリックし、各仮想マシンの RDP ファイルをローカル ディレクトリにダウンロードします。 仮想マシンを選択するには、次のスクリーン ショットに示すように、行の最初のセル以外の場所をクリックします。
   
    ![RDP ファイルのダウンロード](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664953.jpg)
2. ダウンロードした RDP ファイルを開き、構成済みの管理者アカウント (**BUILTIN\AzureAdmin**) とパスワード (**Contoso!000**) を使用して仮想マシンにサインインします。
3. サインインすると、**[サーバー マネージャー]** ダッシュボードが表示されます。 左側のウィンドウで **[ローカル サーバー]** をクリックします。
4. **[IPv4 アドレス (DHCP により割り当て)、IPv6 (有効)]** リンクをクリックします。
5. **[ネットワーク接続]** ダイアログ ボックスで、ネットワーク アイコンをクリックします。
   
    ![仮想マシンの優先 DNS サーバーの変更](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784629.png)
6. コマンド バーの **[Change the settings of this connection (この接続の設定を変更する)]** をクリックします。 (ウィンドウのサイズによっては、右向き二重矢印をクリックしないと、このコマンドが表示されない場合があります。)
7. **[インターネット プロトコル バージョン 4 (TCP/IPv4)]** を選択し、**[プロパティ]** をクリックします。
8. **[次の DNS サーバーのアドレスを使う]** を選択し、**[優先 DNS サーバー]** に「**10.10.2.4**」を指定します。
9. **10.10.2.4** のアドレスは、Azure Virtual Network の 10.10.2.0/24 サブネット内の仮想マシンに割り当てられているアドレスです。 その仮想マシンが **ContosoDC** です。 **ContosoDC** の IP アドレスを確認するには、次のスクリーンショットに示すように、コマンド プロンプト ウィンドウで **nslookup contosodc** を使用します。
   
    ![NSLOOKUP を使用してドメイン コントローラーの IP アドレスを検索](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664954.jpg)
10. **[OK]** > **[閉じる]** とクリックして変更を適用します。 これで仮想マシンをバーチャル マシンを **corp.contoso.com** に参加させることができます。
11. **[ローカル サーバー]** ウィンドウに戻り、**[ワークグループ]** のリンクをクリックします。
12. **[コンピューター名]** セクションで **[変更]** をクリックします。
13. **[ドメイン]** チェック ボックスをオンにし、テキスト ボックスに「**corp.contoso.com**」と入力して、**[OK]** をクリックします。
14. **[Windows セキュリティ]** ダイアログ ボックスで、既定のドメイン管理者の資格情報であるアカウント (**CORP\AzureAdmin**) とパスワード (**Contoso!000**) を指定します。
15. "corp.contoso.com ドメインへようこそ" のメッセージが表示されたら、 **[OK]**をクリックします。
16. ダイアログ ボックスで **[閉じる]** > **[今すぐ再起動]** をクリックします。

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-virtual-machine"></a>各仮想マシンで Corp \Install ユーザーを管理者として追加する
1. 仮想マシンが再起動されるまで待機してから、再度 RDP ファイルを開き、**BUILTIN\AzureAdmin** アカウントを使用して仮想マシンにサインインします。
2. **サーバー マネージャー**で、**[ツール]** > **[コンピューターの管理]** をクリックします。
   
    ![[コンピューターの管理]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784630.png)
3. **[コンピューターの管理]** ダイアログ ボックスで、**[ローカル ユーザーとグループ]** を展開し、**[グループ]** をクリックします。
4. **[Administrators]** グループをダブルクリックします。
5. **[Administrators のプロパティ]** ダイアログ ボックスで、**[追加]** をクリックします。
6. ユーザーに「**CORP\Install**」を入力し、**[OK]** をクリックします。 資格情報の入力を求められたら、**AzureAdmin** アカウントと **Contoso!000** パスワードを使用します。
7. **[OK]** をクリックして **[管理者のプロパティ]** ダイアログ ボックスを閉じます。

### <a name="add-the-failover-clustering-feature-to-each-virtual-machine"></a>各仮想マシンへのフェールオーバー クラスタリング機能の追加
1. **[サーバー マネージャー]** ダッシュボードの **[役割と機能の追加]** をクリックします。
2. **役割と機能の追加ウィザード**で、**[機能]** ページが表示されるまで **[次へ]** をクリックします。
3. **[フェールオーバー クラスタリング]**を選択します。 メッセージが表示されたら、その他の依存する機能を追加します。
   
    ![仮想マシンへのフェールオーバー クラスタリング機能の追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784631.png)
4. **[次へ]** をクリックして、**[確認]** ページの **[インストール]** をクリックします。
5. **フェールオーバー クラスタリング**機能のインストールが終了したら、**[閉じる]** をクリックします。
6. 仮想マシンからサインアウトします。
7. 3 つのサーバー (**ContosoWSFCNode**、**ContosoSQL1**、**ContosoSQL2**) すべてで、このセクションの手順を繰り返します。

これで SQL Server 仮想マシンがプロビジョニングされ、実行されていますが、各仮想マシンでは SQL Server の既定のオプションが使用されています。

## <a name="create-the-failover-cluster"></a>フェールオーバー クラスターを作成する
このセクションでは、後で作成する可用性グループをホストするフェールオーバー クラスターを作成します。 ここまでに、フェールオーバー クラスター内で使用する 3 つの仮想マシンに対して、次の操作を行いました。

* Azure で仮想マシンを完全にプロビジョニングした
* 仮想マシンをドメインに参加させた
* ローカルの Administrators グループに **CORP\Install** を追加する
* フェールオーバー クラスタリング機能を追加した

これらはすべて、フェールオーバー クラスターに参加させるための各仮想マシンでの前提条件です。

また、Azure Virtual Network の動作は、オンプレミス ネットワークとは異なることに注意してください。 クラスターは、次の順序で作成する必要があります。

1. 1 つのノードに単一ノード クラスターを作成します (**ContosoSQL1**)。
2. クラスターの IP アドレスを未使用の IP アドレス (**10.10.2.101**) に変更します。
3. クラスター名をオンラインにします。
4. 他のノード (**ContosoSQL2** と **ContosoWSFCNode**) を追加します。

次の手順を使用して、クラスターを完全に構成するタスクを完了します。

1. **ContosoSQL1** の RDP ファイルを開き、ドメイン アカウント **CORP\Install** を使用してサインインします。
2. **[サーバー マネージャー]** ダッシュボードで、**[ツール]** > **[フェールオーバー クラスター マネージャー]** をクリックします。
3. 次のスクリーンショットに示すように、左側のウィンドウで **[フェールオーバー クラスター マネージャー]** を右クリックし、**[クラスターの作成]** をクリックします。
   
    ![クラスターの作成](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784632.png)
4. クラスターの作成ウィザードの各ページで、次の表の設定を使って、単一ノード クラスターを作成します。
   
   | ページ | [設定] |
   | --- | --- |
   | 開始する前に |既定値を使用 |
   | サーバーの選択 |**[サーバー名の入力]** に「**ContosoSQL1**」と入力し、**[追加]** をクリックします。 |
   | 検証の警告 |**[いいえ、このクラスターに Microsoft のサポートは必要ありませんので、検証テストを実行しません。[次へ] をクリックして、クラスターの作成を続行します。]** を選択します。 |
   | クラスター管理用のアクセス ポイント |**[クラスター名]** に「**Cluster1**」と入力します。 |
   | [次へ] |記憶域スペースを使用している場合を除き、既定値を使用します。 この表の次の警告を参照してください。 |
   
   > [!WARNING]
   > 複数のディスクを記憶域プールにグループ化する[記憶域スペース](https://technet.microsoft.com/library/hh831739)を使用している場合は、**[確認]** ページの **[使用可能な記憶域をすべてクラスターに追加する]** チェック ボックスをオフにする必要があります。 このチェック ボックスをオフにしないと、クラスタリング処理中に仮想ディスクがデタッチされます。 その結果、記憶域スペースがクラスターから削除され、PowerShell を使用して再アタッチされるまで、仮想ディスクはディスク マネージャーやエクスプローラーにも表示されなくなります。
   > 
   > 
5. 左側のウィンドウで、**[フェールオーバー クラスター マネージャー]** を展開し、**[Cluster1.corp.contoso.com]** をクリックします。
6. 中央のウィンドウで、下方法へスクロールして **[クラスター コア リソース]** セクションを表示し、**[名前: Clutser1]** の詳細を展開します。 **[名前]** と **[IP アドレス]** リソースの両方が **[失敗]** 状態で表示されます。 クラスターにコンピューター自体と同じ IP アドレスが割り当てられていて、アドレスが重複するため、IP アドレス リソースをオンラインにすることができません。
7. 失敗した **IP アドレス** リソースを右クリックし、**[プロパティ]** をクリックします。
   
    ![クラスターのプロパティ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784633.png)
8. **[静的 IP アドレス]** を選択し、**[アドレス]** テキスト ボックスに「**10.10.2.101**」を指定して、**[OK]** をクリックします。
9. **[クラスター コア リソース]** セクションで、**[名前: Cluster1]** を右クリックして、**[オンラインにする]** をクリックします。 両方のリソースがオンラインになるまで待ちます。 クラスター名リソースがオンラインになると、新しい Active Directory コンピューター アカウントで DC サーバーが更新されます。 この Active Directory アカウントは、後で可用性グループのクラスター化サービスを実行するのに使用されます。
10. 残りのノードをクラスターに追加します。 次のスクリーンショットに示すように、ブラウザー ツリーで **[Cluster1.corp.contoso.com]** を右クリックして、**[ノードの追加]** をクリックします。
    
     ![クラスターにノードを追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784634.png)
11. **ノードの追加ウィザード**で、**[サーバーの選択]** ページの **[次へ]** をクリックし、**ContosoSQL2** と **ContosoWSFCNode** を一覧に追加します。これには、**[サーバー名の入力]** にサーバー名を入力し、**[追加]** をクリックします。 完了したら、**[次へ]** をクリックします。
12. 実際の運用時には、検証テストを実施する必要がありますが、**[検証の警告]** ページで **[いいえ]** をクリックします。 次に、 **[次へ]**をクリックします。
13. **[確認]** ページで **[次へ]** をクリックしてノードを追加します。
    
    > [!WARNING]
    > 複数のディスクを記憶域プールにグループ化する [記憶域スペース](https://technet.microsoft.com/library/hh831739)を使用している場合は、**[使用可能な記憶域をすべてクラスターに追加する]** チェック ボックスをオフにする必要があります。 このチェック ボックスをオフにしないと、クラスタリング処理中に仮想ディスクがデタッチされます。 その結果、記憶域スペースがクラスターから削除され、PowerShell を使用して再アタッチされるまで、仮想ディスクはディスク マネージャーやエクスプローラーにも表示されなくなります。
    > 
    > 
14. ノードがクラスターに追加されたら、**[完了]**をクリックします。 フェールオーバー クラスター マネージャーでは、クラスターに 3 つのノードがあることが示され、その 3 つのノードが **[ノード]** コンテナーの一覧に表示されます。
15. リモート デスクトップ セッションからサインアウトします。

## <a name="prepare-the-sql-server-instances-for-availability-groups"></a>可用性グループの SQL Server インスタンスの準備
このセクションでは、**ContosoSQL1** と **contosoSQL2** の両方で、次の操作を行います。

* 既定の SQL Server インスタンスに対する必要なアクセス許可を設定して **NT AUTHORITY\System** のログインを追加します。
* 既定の SQL Server インスタンスの sysadmin ロールとして **CORP\Install** を追加します。
* ファイアウォールを解放し、SQL Server のリモート アクセスを許可します。
* AlwaysOn 可用性グループ機能を有効にします。
* SQL Server サービス アカウントを **CORP\SQLSvc1** と **CORP\SQLSvc2** にそれぞれ変更します。

上記の操作は、任意の順序で実行できます。 ただし、以下の手順はこの順序どおりに実行します。 この手順は、**ContosoSQL1** と **ContosoSQL2** の両方で実行します。

1. 仮想ネットワークのリモート デスクトップ セッションからサインアウトしていない場合は、ここでサインアウトします。
2. **ContosoSQL1** と **ContosoSQL2** の RDP ファイルを開き、**BUILTIN\AzureAdmin** としてサインインします。
3. 必要なアクセス許可と共に **NT AUTHORITY\System** を SQL Server ログインに追加します。 **SQL Server Management Studio**を開きます。
4. **[接続]** をクリックして、既定の SQL Server インスタンスに接続します。
5. **オブジェクト エクスプローラー**で、**[セキュリティ]**、**[ログイン]** の順に展開します。
6. **[NT AUTHORITY\System]** ログインを右クリックし、**[プロパティ]** をクリックします。
7. ローカル サーバーの **[セキュリティ保護可能なリソース]** ページで、次のアクセス許可の **[許可]** を選択し、**[OK]** をクリックします。
   
   * 可用性グループの変更
   * SQL の接続
   * サーバー状態の表示
8. 既定の SQL Server インスタンスの **sysadmin** ロールとして **CORP\Install** を追加します。 **オブジェクト エクスプローラー**で、**[ログイン]** を右クリックし、**[新しいログイン]** をクリックします。
9. **[ログイン名]** に「**CORP\Install**」と入力します。
10. **[サーバーの役割]** ページで、**[sysadmin]** を選択し、**[OK]** をクリックします。 作成したログインは、**オブジェクト エクスプローラー**で **[ログイン]** を展開すると確認できます。
11. SQL Server のファイアウォール ルールを作成するため、**[開始]** 画面で **[セキュリティが強化された Windows ファイアウォール]** を開きます。
12. 左側のウィンドウで、 **[受信の規則]**を選択します。 右側のウィンドウで、**[新しい規則]**をクリックします。
13. **[規則の種類]** ページで **[プログラム]** > **[次へ]** をクリックします。
14. **[プログラム]** ページで、**[このプログラムのパス]** を選択し、テキスト ボックスに「**%ProgramFiles%\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\sqlservr.exe**」と入力して **[次へ]** をクリックします。 SQL Server 2012 を使用してこれらの指示に従っている場合の SQL Server ディレクトリは、**MSSQL11.MSSQLSERVER** です。
15. **[操作]** ページで、**[接続を許可する]** を選択したまま、**[次へ]** をクリックします。
16. **[プロファイル]** ページで、既定の設定をそのまま使用し、**[次へ]** をクリックします。
17. **[名前]** ページで、**[名前]** ボックスに規則の名前 (**SQL Server (プログラム規則)** など) を指定し、**[完了]** をクリックします。
18. **Always On 可用性グループ**機能を有効にするため、**[開始]** 画面で、**SQL Server 構成マネージャー**を開きます。
19. ブラウザー ツリーで、**[SQL Server のサービス]** をクリックし、**[SQL Server (MSSQLSERVER)]** サービスを右クリックして、**[プロパティ]** をクリックします。
20. 次のスクリーンショットに示すように、**[AlwaysOn 高可用性]** タブをクリックし、**[AlwaysOn 可用性グループを有効にする]** をオンにして、**[適用]** をクリックします。 ダイアログ ボックスで **[OK]** をクリックします。**[プロパティ]** ダイアログ ボックスはまだ閉じないでください。 サービス アカウントを変更した後に SQL Server サービスを再起動します。
    
     ![AlwaysOn 可用性グループの有効化](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665520.gif)
21. SQL Server サービス アカウントを変更するため、**[ログオン]** タブをクリックし、**[アカウント名]** に「**CORP\SQLSvc1**」(**ContosoSQL1** の場合) または「**CORP\SQLSvc2**」(**ContosoSQL2** の場合) を入力します。その後、パスワードを入力および確認入力し、**[OK]** をクリックします。
22. 開いたダイアログ ボックスで **[はい]** をクリックし、SQL Server サービスを再起動します。 SQL Server サービスが再起動されると、**[プロパティ]** ダイアログ ボックスで行った変更が有効になります。
23. 仮想マシンからサインアウトします。

## <a name="create-the-availability-group"></a>可用性グループの作成
これで、可用性グループを構成できるようになりました。 この後の操作の概要は以下のとおりです。

* **ContosoSQL1** に新しいデータベース (**MyDB1**) を作成します。
* データベースの完全バックアップとトランザクション ログ バックアップの両方を作成します。
* **NORECOVERY** オプションを使用して完全バックアップとログ バックアップを **ContosoSQL2** に復元します。
* 同期コミット、自動フェールオーバー、読み取り可能なセカンダリのレプリカを含む可用性グループ (**AG1**) を作成します。

### <a name="create-the-mydb1-database-on-contososql1"></a>ContosoSQL1 での MyDB1 データベースの作成
1. **ContosoSQL1** と **ContosoSQL2** のリモート デスクトップ セッションからまだサインアウトしていない場合は、ここでサインアウトします。
2. **ContosoSQL1** の RDP ファイルを開き、**CORP\Install** としてサインインします。
3. **エクスプローラー**で、**C:\\** ドライブの下に **backup** というディレクトリを作成します。 このディレクトリは、データベースのバックアップと復元に使用します。
4. 次のスクリーンショットに示すように、新しいディレクトリを右クリックして **[共有]** をポイントし、**[特定のユーザー]** をクリックします。
   
    ![バックアップ フォルダーの作成](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665521.gif)
5. **CORP\SQLSvc1** を追加し、それに**読み取り/書き込み**アクセス許可を付与します。 次のスクリーン ショットに示すように、**CORP\SQLSvc2** を追加し、それに**読み取り**アクセス許可を付与したら、**[共有]** をクリックします。 ファイル共有の処理が終了したら、**[完了]**をクリックします。
   
    ![バックアップ フォルダーのアクセス許可の付与](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665522.gif)
6. データベースを作成するため、**[スタート]** メニューから **SQL Server Management Studio** を開きし、**[接続]** をクリックして既定の SQL Server インスタンスに接続します。
7. **オブジェクト エクスプローラー**で、**[データベース]** を右クリックし、**[新しいデータベース]** をクリックします。
8. **[データベース名]** に「**MyDB1**」と入力し、**[OK]** をクリックします。

### <a name="make-a-full-backup-of-mydb1-and-restore-it-on-contososql2"></a>MyDB1 の完全バックアップの作成と ContosoSQL2 への復元
1. データベースの完全バックアップを作成するため、**オブジェクト エクスプローラー**で、**[データベース]** を展開し、**[MyDB1]** を右クリックして **[タスク]** をポイントし、**[バックアップ]** をクリックします。
2. **[ソース]** セクションで、**[バックアップの種類]** を **[完全]** に設定しておきます。 **[バックアップ先]** セクションで、**[削除]** をクリックして、バックアップ ファイルの既定のファイル パスを削除します。
3. **[バックアップ先]** セクションで、**[追加]** をクリックします。
4. **[ファイル名]** テキスト ボックスに「**\\ContosoSQL1\backup\MyDB1.bak**」と入力して **[OK]** をクリックし、もう一度 **[OK]** をクリックしてデータベースをバックアップします。 バックアップ操作が終了したら、もう一度 **[OK]** をクリックしてダイアログ ボックスを閉じます。
5. データベースのトランザクション ログのバックアップを作成するため、**オブジェクト エクスプローラー**で、**[データベース]** を展開し、**[MyDB1]** を右クリックして **[タスク]** をポイントし、**[バックアップ]** をクリックします。
6. **[バックアップの種類]** で **[トランザクション ログ]** を選択します。 **[バックアップ先]** のファイル パスは、前に指定したパスに設定したままにして、**[OK]** をクリックします。 バックアップ操作が終了したら、もう一度 **[OK]** をクリックします。
7. 完全バックアップとトランザクション ログのバックアップを復元するため、**ContosoSQL2** で **ContosoSQL2** の RDP ファイルを開き、**CORP\Install** としてサインインします。 **ContosoSQL1** のリモート デスクトップ セッションは、開いたままにします。
8. **[スタート]** メニューから **SQL Server Management Studio** を開き、**[接続]** をクリックして既定の SQL Server インスタンスに接続します。
9. **オブジェクト エクスプローラー**で、**[データベース]** を右クリックし、**[データベースの復元]** をクリックします。
10. **[ソース]** セクションで **[デバイス]** を選択し、省略記号 (**…**) ボタンを選択します。
11. **[バックアップ デバイスの選択]** で、**[追加]** をクリックします。
12. **[バックアップ ファイルの場所]** に「**\\ContosoSQL1\backup**」と入力して **[更新]** をクリックし、**[MyDB1.bak]** を選択して **[OK]** をクリックした後、もう一度 **[OK]** をクリックします。 **[復元するバックアップ セット]** ウィンドウに完全バックアップとログ バックアップが表示されます。
13. **[オプション]** ページに移動し、**[復旧状態]** で **[RESTORE WITH NORECOVERY]** を選択し、**[OK]** をクリックしてデータベースを復元します。 復元操作が終了したら、**[OK]** をクリックします。

### <a name="create-the-availability-group"></a>可用性グループの作成
1. **ContosoSQL1**のリモート デスクトップ セッションに戻ります。 次のスクリーンショットに示すように、SQL Server Management Studio の**オブジェクト エクスプローラー**で、**[AlwaysOn 高可用性]** を右クリックし、**[新しい可用性グループ ウィザード]** をクリックします。
   
    ![新しい可用性グループ ウィザードの起動](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665523.gif)
2. **[説明]** ページで **[次へ]** をクリックします。 **[可用性グループ名の指定]** ページで、**[可用性グループ名]** に「**AG1**」と入力し、もう一度 **[次へ]** をクリックします。
   
    ![新しい可用性グループ ウィザードでは、可用性グループ名の指定](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665524.gif)
3. **[データベースの選択]** ページで、**[MyDB1]** を選択し、**[次へ]** をクリックします。 対象とするプライマリ レプリカで完全バックアップを少なくとも 1 つは作成しているため、このデータベースは可用性グループの前提条件を満たしています。
   
    ![新しい可用性グループ ウィザード、データベースの選択](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665525.gif)
4. **[レプリカの指定]** ページで **[レプリカの追加]** をクリックします。
   
    ![新しい可用性グループ ウィザード、レプリカの指定](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665526.gif)
5. **[サーバーへの接続**] ダイアログ ボックスで、**[サーバー名]** に「**ContosoSQL2**」と入力し、**[接続]** をクリックします。
   
    ![新しい可用性グループ ウィザード、サーバーへの接続](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665527.gif)
6. **[レプリカの指定]** ページに戻ると、**[可用性レプリカ]** の一覧に **ContosoSQL2** が表示されていることがわかります。 次のスクリーンショットに示すようにレプリカを構成します。 構成し終わったら、 **[次へ]**をクリックします。
   
    ![新しい可用性グループ ウィザード、レプリカの指定 (完了)](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665528.gif)
7. **[最初のデータの同期を選択]** ページで、**[結合のみ]** を選択し、**[次へ]** をクリックします。 データの同期は既に、**ContosoSQL1** で完全バックアップとトランザクション バックアップを作成し、**ContosoSQL2** で復元したときに手動で実行しました。 データベースのバックアップの作成と復元を実行しないことを選択し、その代わり、新しい可用性グループ ウィザードで **[完全]** を選択し、データの同期を自動で実行させることができます。 ただし、一部の企業で使用されている大規模なデータベースの場合、このオプションはお勧めしません。
   
    ![新しい可用性グループ ウィザード、最初のデータの同期を選択](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665529.gif)
8. **[検証]** ページで **[次へ]** をクリックします。 このページは次のスクリーンショットのようになります。 可用性グループ リスナーを構成していないため、リスナー構成に関する警告が表示されます。 このチュートリアルではリスナーを構成しないため、この警告を無視できます。 このチュートリアルの完了後にリスナーを構成する場合は、「[Azure での AlwaysOn 可用性グループの ILB リスナーの構成](../classic/ps-sql-int-listener.md)」をご覧ください。
   
    ![新しい可用性グループ ウィザード、検証](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665530.gif)
9. **[概要]** ページで、**[完了]** をクリックし、新しい可用性グループが構成されるまで待ちます。 **[進行状況]** ページで **[詳細]** をクリックすると、進行状況が詳しく表示されます。 ウィザードが完了したら、**[結果]** ページを調べて、次のスクリーンショットに示すように、可用性グループが正常に作成されたことを確認します。その後、**[閉じる]** をクリックしてウィザードを終了します。
   
    ![新しい可用性グループ ウィザード、結果](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665531.gif)
10. **オブジェクト エクスプローラー**で、**[AlwaysOn 高可用性]**、**[可用性グループ]** の順に展開します。 このコンテナー内に新しい可用性グループが表示されます。 **[AG1 (プライマリ)]** を右クリックして **[ダッシュボードの表示]** をクリックします。
    
     ![可用性グループ ダッシュ ボードの表示](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665532.gif)
11. **AlwaysOn ダッシュボード**が、次のスクリーンショットのように表示されます。 レプリカ、各レプリカのフェールオーバー モード、および同期の状態を確認できます。
    
     ![可用性グループ ダッシュ ボード](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665533.gif)
12. **[サーバー マネージャー]** に戻り、**[ツール]** をクリックし、**[フェールオーバー クラスター マネージャー]** を開きます。
13. **[Cluster1.corp.contoso.com]**、**[サービスとアプリケーション]** の順に展開します。 **[役割]** を選択し、**AG1** 可用性グループの役割が作成されていることに注目します。 リスナーを構成していないため、AG1 には、データベース クライアントが可用性グループに接続するときに使用する IP アドレスがありません。 読み取り/書き込み操作の場合はプライマリ ノードに、読み取り専用クエリの場合はセカンダリ ノードに直接接続できます。
    
     ![フェールオーバー クラスター マネージャー内のAG](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665534.gif)

> [!WARNING]
> フェールオーバー クラスター マネージャーから、可用性グループのフェールオーバーを実行しないでください。 すべてのフェールオーバー操作は、SQL Server Management Studio の **AlwaysOn ダッシュボード**内から実行する必要があります。 詳細については、[フェールオーバー クラスター マネージャーと可用性グループの使用に関する制限事項](https://msdn.microsoft.com/library/ff929171.aspx)のページを参照してください。
> 
> 

## <a name="next-steps"></a>次のステップ
これで、Azure に可用性グループを作成して、SQL Server AlwaysOn を正常に実装できました。 この可用性グループのリスナーを構成するには、「[Azure での AlwaysOn 可用性グループの ILB リスナーの構成](../classic/ps-sql-int-listener.md)」をご覧ください。

Azure での SQL Server の使用に関するその他の情報については、「 [Azure Virtual Machines における SQL Server](../sql/virtual-machines-windows-sql-server-iaas-overview.md)」を参照してください。

